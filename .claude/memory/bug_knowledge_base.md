# AI Smart Diet Lens - é—®é¢˜çŸ¥è¯†åº“

> è®°å½•å‰åç«¯è”è°ƒä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

## åç«¯é—®é¢˜

### 1. ç”¨æˆ·èµ„æ–™ç«¯ç‚¹å®‰å…¨æ¼æ´ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

**é—®é¢˜æè¿°**:
`GET /api/user/:id` å’Œ `PUT /api/user/:id/profile` ç«¯ç‚¹æ²¡æœ‰è®¤è¯ä¿æŠ¤ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®å’Œä¿®æ”¹ä»»ä½•ç”¨æˆ·çš„èµ„æ–™ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ  `@UseGuards(JwtGuard)` è®¤è¯ä¿æŠ¤
- æ·»åŠ æ‰€æœ‰æƒæ£€æŸ¥ï¼šåªèƒ½è®¿é—®/ä¿®æ”¹è‡ªå·±çš„èµ„æ–™
- Service å±‚æ·»åŠ  `currentUserId` å‚æ•°éªŒè¯

---

### 2. CORS é…ç½®é—®é¢˜ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**é—®é¢˜æè¿°**:
å½“ `credentials: true` ä¸ `origin: '*'` ç»„åˆä½¿ç”¨æ—¶ï¼Œæµè§ˆå™¨ä¼šæŠ¥ CORS é”™è¯¯ï¼š
```
The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*'
```

**åŸå› **:
å½“éœ€è¦æ”¯æŒæºå¸¦å‡­è¯çš„è¯·æ±‚æ—¶ï¼Œ`origin` å¿…é¡»æ˜¯å…·ä½“çš„åŸŸåï¼Œä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ã€‚

**è§£å†³æ–¹æ¡ˆ**:
å°† `origin` æ”¹ä¸ºå‡½æ•°ï¼ŒåŠ¨æ€æ£€æŸ¥è¯·æ±‚æ¥æºï¼š
- å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰ `localhost` å’Œ `127.0.0.1` ç«¯å£
- ç”Ÿäº§ç¯å¢ƒé€šè¿‡ `CORS_ORIGIN` ç¯å¢ƒå˜é‡é…ç½®å…è®¸çš„åŸŸååˆ—è¡¨
- æ˜ç¡®é…ç½® `allowedHeaders` å’Œ `methods`

**éªŒè¯**:
```bash
curl -I -X OPTIONS http://localhost:3000/api/auth/send-code \
  -H "Origin: http://localhost:5173" \
  -H "Access-Control-Request-Method: POST"
# è¿”å›: Access-Control-Allow-Origin: http://localhost:5173
#       Access-Control-Allow-Credentials: true
```

---

### 3. API æ»¥ç”¨é£é™© âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - å®‰å…¨åŠ å›º

**é—®é¢˜æè¿°**:
æ²¡æœ‰ Rate Limitingï¼ŒAPI å¯èƒ½è¢«æ»¥ç”¨ï¼š
- éªŒè¯ç è½°ç‚¸
- æš´åŠ›ç ´è§£ç™»å½•
- èµ„æºè€—å°½æ”»å‡»

**è§£å†³æ–¹æ¡ˆ**:
æ·»åŠ  `@nestjs/throttler` åŒ…ï¼Œé…ç½®ä¸‰çº§é™æµï¼š
- **Short**: 60æ¬¡/åˆ†é’Ÿ
- **Medium**: 200æ¬¡/5åˆ†é’Ÿ
- **Long**: 1000æ¬¡/å°æ—¶

å…³é”®ç«¯ç‚¹é™æµï¼š
- å‘é€éªŒè¯ç : 5æ¬¡/åˆ†é’Ÿ
- ç™»å½•: 10æ¬¡/åˆ†é’Ÿ
- ä¸Šä¼ : 20æ¬¡/åˆ†é’Ÿ

---

### 4. ä¸Šä¼ æœåŠ¡å®‰å…¨é—®é¢˜ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - å®‰å…¨åŠ å›º

**é—®é¢˜æè¿°**:
- æ²¡æœ‰æ–‡ä»¶ç±»å‹éªŒè¯ï¼Œå¯èƒ½ä¸Šä¼ æ¶æ„æ–‡ä»¶
- æ²¡æœ‰æ–‡ä»¶å¤§å°é™åˆ¶
- ä½¿ç”¨ `Math.random()` ç”Ÿæˆæ–‡ä»¶åä¸å¤Ÿå®‰å…¨

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ æ–‡ä»¶ç±»å‹ç™½åå•ï¼šä»…å…è®¸å›¾ç‰‡æ ¼å¼ (JPEG, PNG, GIF, WebP, HEIC)
- æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶ï¼šæœ€å¤§ 10MB
- ä½¿ç”¨ `crypto.randomBytes()` æ›¿ä»£ `Math.random()`

---

### 6. Diary æ¨¡å—æ‰€æœ‰æƒæ£€æŸ¥ç¼ºå¤± âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

**é—®é¢˜æè¿°**:
`PATCH /api/diary/entry/:id` å’Œ `DELETE /api/diary/entry/:id` æ²¡æœ‰æ‰€æœ‰æƒæ£€æŸ¥ï¼Œç”¨æˆ·å¯ä»¥ä¿®æ”¹æˆ–åˆ é™¤å…¶ä»–ç”¨æˆ·çš„æ—¥è®°æ¡ç›®ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- Service å±‚æ·»åŠ  `userId` å‚æ•°
- Controller å±‚ä¼ é€’ `@CurrentUser().sub`
- éªŒè¯æ¡ç›®çš„ `userId` æ˜¯å¦ä¸å½“å‰ç”¨æˆ·åŒ¹é…

---

### 7. é‡å¤çš„ JWT Guard æ–‡ä»¶ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ä»£ç è´¨é‡

**é—®é¢˜æè¿°**:
å­˜åœ¨ä¸¤ä¸ªåŠŸèƒ½ç›¸åŒçš„ JWT Guard æ–‡ä»¶ï¼š
- `jwt.guard.ts` - æ­£åœ¨ä½¿ç”¨
- `jwt-auth.guard.ts` - æœªä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:
åˆ é™¤æœªä½¿ç”¨çš„ `jwt-auth.guard.ts`ï¼Œç»Ÿä¸€ä½¿ç”¨ `JwtGuard`ã€‚

---

### 8. è¯·æ±‚è¿½è¸ªç¼ºå¤± âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - å¯è§‚æµ‹æ€§

**é—®é¢˜æè¿°**:
æ²¡æœ‰è¯·æ±‚ IDï¼Œéš¾ä»¥åœ¨æ—¥å¿—ä¸­è¿½è¸ªç‰¹å®šè¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

**è§£å†³æ–¹æ¡ˆ**:
- æ–°å¢ `RequestIdMiddleware` ä¸­é—´ä»¶
- ä½¿ç”¨ `crypto.randomBytes()` ç”Ÿæˆå”¯ä¸€ ID
- åœ¨å“åº”å¤´æ·»åŠ  `X-Request-ID`
- è®°å½•è¯·æ±‚è€—æ—¶ï¼ˆæ–¹æ³• + è·¯å¾„ + çŠ¶æ€ç  + è€—æ—¶ï¼‰

---

### 5. å¼€å‘æ¨¡å¼éªŒè¯ç è·å–ç«¯ç‚¹

**ç«¯ç‚¹**: `GET /api/auth/dev/code?email=xxx`

**ç”¨é€”**: å¼€å‘ç¯å¢ƒä¸‹è·å–é‚®ç®±å¯¹åº”çš„éªŒè¯ç ï¼Œæ–¹ä¾¿æµ‹è¯•

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "email": "test@example.com",
    "code": "123456",
    "expiresAt": "2026-02-06T16:39:39.397Z"
  }
}
```

---

## å‰ç«¯é—®é¢˜

### 1. UniApp æ¨¡æ¿ä¸­ `uni` å…¨å±€å¯¹è±¡ç±»å‹é”™è¯¯ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**é—®é¢˜æè¿°**:
åœ¨ Vue æ¨¡æ¿ä¸­ä½¿ç”¨ `uni.navigateTo` ç­‰å…¨å±€æ–¹æ³•æ—¶ï¼ŒTypeScript æŠ¥é”™ï¼š
```
ç±»å‹ä¸Šä¸å­˜åœ¨å±æ€§"uni"
```

**åŸå› **:
UniApp çš„å…¨å±€å¯¹è±¡ `uni` åœ¨æ¨¡æ¿ä¸Šä¸‹æ–‡ä¸­æœªè¢«æ­£ç¡®è¯†åˆ«ã€‚

**è§£å†³æ–¹æ¡ˆ**:
å°†å†…è”çš„ `uni` è°ƒç”¨ç§»åˆ° script ä¸­å®šä¹‰çš„æ–¹æ³•ï¼š
```typescript
// âŒ é”™è¯¯ï¼šæ¨¡æ¿ä¸­ç›´æ¥ä½¿ç”¨
@tap="() => uni.navigateTo({ url: '/pages/login' })"

// âœ… æ­£ç¡®ï¼šåœ¨ script ä¸­å®šä¹‰æ–¹æ³•
const goToLogin = () => {
  uni.navigateTo({ url: '/pages/onboarding/login' })
}
// æ¨¡æ¿ä¸­ä½¿ç”¨
@tap="goToLogin"
```

---

### 2. æ¨¡æ¿åµŒå¥—ç»“æ„é—®é¢˜ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**:
ä½¿ç”¨ `<template v-else>` æ—¶å¿˜è®°æ·»åŠ é—­åˆæ ‡ç­¾ `</template>`ï¼Œå¯¼è‡´æ¨¡æ¿è§£æé”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿ `<template v-else>` æœ‰å¯¹åº”çš„é—­åˆæ ‡ç­¾ï¼š
```html
<template>
  <view>
    <view v-if="!isLoggedIn">ç™»å½•æç¤º</view>
    <template v-else>
      <!-- ä¸»å†…å®¹ -->
      <BottomNav />
    </template>  <!-- å¿…é¡»ï¼šé—­åˆ v-else æ¨¡æ¿ -->
  </view>
</template>
```

---

## å·²å®Œæˆçš„å‰åç«¯é›†æˆ

### é¡µé¢é›†æˆçŠ¶æ€

| é¡µé¢ | çŠ¶æ€ | é›†æˆå†…å®¹ |
|:-----|:-----|:---------|
| **é¦–é¡µ (Index)** | âœ… | useDashboard, ç™»å½•æ£€æŸ¥ |
| **æ¶ˆæ¯ä¸­å¿ƒ (Messages)** | âœ… | NotificationsService, å·²è¯»/æœªè¯» |
| **AI åˆ†æ (Analysis)** | âœ… | useAnalysis, çƒ­é‡è¶‹åŠ¿, è¥å…»åˆ†å¸ƒ |
| **ä¸ªäººä¸­å¿ƒ (Profile)** | âœ… | useUserStore, useDashboard, ç™»å‡º |
| **è®¾ç½® (Settings)** | â³ | å¾…é›†æˆ |

### æ–°å¢ Composables

| æ–‡ä»¶ | åŠŸèƒ½ |
|:-----|:-----|
| `useDashboard.ts` | ä»ªè¡¨ç›˜æ•°æ®ç®¡ç† |
| `useAnalysis.ts` | è¥å…»åˆ†æè¶‹åŠ¿æ•°æ® |
| `useRouteGuard.ts` | è·¯ç”±å®ˆå« |

### æ–°å¢ Services

| æ–‡ä»¶ | åŠŸèƒ½ |
|:-----|:-----|
| `dashboard.service.ts` | ä»ªè¡¨ç›˜ API |
| `notifications.service.ts` | æ¶ˆæ¯é€šçŸ¥ API |

---

## åç«¯ä¼ä¸šçº§å®‰å…¨å®¡è®¡ (2026-02-06)

### 9. å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨ç±»å‹é”™è¯¯ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ä»£ç è´¨é‡

**é—®é¢˜æè¿°**:
`global-exception.filter.ts` ä¸­ä½¿ç”¨äº† `Request` ç±»å‹ä½†æ²¡æœ‰ä» `express` å¯¼å…¥ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:
æ·»åŠ  `Request` ç±»å‹å¯¼å…¥ï¼š
```typescript
// Before
import { Response } from 'express'

// After
import { Request, Response } from 'express'
```

---

### 10. å…¬å¼€ API ç«¯ç‚¹ç¼ºå°‘é€Ÿç‡é™åˆ¶ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - API æ»¥ç”¨é˜²æŠ¤

**é—®é¢˜æè¿°**:
ä»¥ä¸‹å…¬å¼€ç«¯ç‚¹æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œå¯èƒ½è¢«æ»¥ç”¨ï¼š
- `GET /api/food/search` - é£Ÿç‰©æœç´¢
- `GET /api/food/barcode/:code` - æ¡å½¢ç æŸ¥è¯¢
- `GET /api/system/bootstrap` - ç³»ç»Ÿå¯åŠ¨é…ç½®

**è§£å†³æ–¹æ¡ˆ**:
æ·»åŠ  `@Throttle` è£…é¥°å™¨ï¼š
```typescript
// é£Ÿç‰©æœç´¢: 30æ¬¡/åˆ†é’Ÿ
@Get('search')
@Throttle({ name: 'short', limit: 30, ttl: 60000 })

// æ¡å½¢ç æŸ¥è¯¢: 30æ¬¡/åˆ†é’Ÿ
@Get('barcode/:code')
@Throttle({ name: 'short', limit: 30, ttl: 60000 })

// ç³»ç»Ÿé…ç½®: 60æ¬¡/åˆ†é’Ÿ
@Get('bootstrap')
@Throttle({ name: 'short', limit: 60, ttl: 60000 })
```

---

### æ¨¡å—æ‰€æœ‰æƒæ£€æŸ¥å®¡æŸ¥ç»“æœ âœ…

æ‰€æœ‰æ¨¡å—çš„ DELETE å’Œ UPDATE æ“ä½œå‡å·²éªŒè¯æ‰€æœ‰æƒæ£€æŸ¥ï¼š

| æ¨¡å— | æ–¹æ³• | æ‰€æœ‰æƒæ£€æŸ¥ |
|:-----|:-----|:----------|
| **User** | `findById`, `updateProfile` | âœ… éªŒè¯ `id === currentUserId` |
| **Diary** | `update`, `remove` | âœ… éªŒè¯ `entry.userId === userId` |
| **Community** | `deletePost`, `deleteComment` | âœ… éªŒè¯ `post.userId === userId` |
| **Notifications** | `markAsRead`, `deleteMessage` | âœ… éªŒè¯ `message.userId === userId` |
| **Favorites** | `removeFavorite` | âœ… éªŒè¯ `favorite.userId === userId` |

---

### è®¤è¯ä¿æŠ¤å®¡æŸ¥ç»“æœ âœ…

æ‰€æœ‰éœ€è¦è®¤è¯çš„æ¨¡å—å‡å·²æ­£ç¡®é…ç½® `@UseGuards(JwtGuard)`ï¼š

| æ¨¡å— | Controller çº§åˆ«ä¿æŠ¤ | æ–¹æ³•çº§åˆ«ä¿æŠ¤ |
|:-----|:-------------------|:-------------|
| **Auth** | - | âœ… `login` (å‘é€éªŒè¯ç é™æµ 5/åˆ†é’Ÿ, ç™»å½• 10/åˆ†é’Ÿ) |
| **User** | - | âœ… `GET :id`, `PUT :id/profile` |
| **Dashboard** | âœ… | - |
| **Food (AI)** | âœ… | - |
| **Diary** | âœ… | - |
| **Gamification** | âœ… | - |
| **Recipe** | âœ… | - |
| **Chat** | âœ… | - |
| **Community** | - | âœ… `createPost`, `toggleLike`, `deletePost`, `addComment`, `deleteComment`, `getMyPosts` |
| **Favorites** | âœ… | - |
| **Notifications** | âœ… | - |
| **Upload** | âœ… | âœ… é¢å¤–æ–‡ä»¶ç±»å‹å’Œå¤§å°éªŒè¯ |

---

**æœ€åæ›´æ–°**: 2026-02-06 (ä¼ä¸šçº§å®‰å…¨å®¡è®¡å®Œæˆ)

---

## å‰ç«¯ä¼ä¸šçº§å®‰å…¨å®¡æŸ¥ (2026-02-06)

### 11. XSS æ³¨å…¥é£é™© âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

**é—®é¢˜æè¿°**:
`pages/ai-chat/index.vue` ä½¿ç”¨ `<rich-text>` ç»„ä»¶ç›´æ¥æ¸²æŸ“æ¥è‡ªåç«¯çš„ `msg.richContent`ï¼Œæœªè¿›è¡Œ HTML æ¸…ç†ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `utils/sanitize.ts` å®ç° HTML æ¸…ç†åŠŸèƒ½
- ä½¿ç”¨æ ‡ç­¾ç™½åå•å’Œå±æ€§é»‘åå•è¿‡æ»¤å±é™©å†…å®¹
- ç§»é™¤æ‰€æœ‰äº‹ä»¶å¤„ç†å±æ€§ (onclick, onload, ç­‰)
- åœ¨æ˜¾ç¤ºå‰å¯¹å¯Œæ–‡æœ¬å†…å®¹è¿›è¡Œæ¸…ç†

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/core/src/utils/sanitize.ts`

---

### 12. Token æ˜æ–‡å­˜å‚¨ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

**é—®é¢˜æè¿°**:
ä½¿ç”¨ `uni.setStorageSync('token', result.token)` æ˜æ–‡å­˜å‚¨ Tokenï¼Œåœ¨å°ç¨‹åºç¯å¢ƒä¸­å¯èƒ½è¢«è½»æ˜“è·å–ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `utils/secure-storage.ts` å®ç°åŠ å¯†å­˜å‚¨
- ä½¿ç”¨å¼‚æˆ–åŠ å¯† + Base64 ç¼–ç ä¿æŠ¤ Token
- æ›´æ–° `auth.ts` store ä½¿ç”¨ `tokenStorage` æ›¿ä»£ç›´æ¥å­˜å‚¨

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/core/src/utils/secure-storage.ts`

---

### 13. é‚®ç®±è¾“å…¥ç¼ºå°‘æ ¼å¼éªŒè¯ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - æ•°æ®éªŒè¯

**é—®é¢˜æè¿°**:
ç™»å½•å’Œæ³¨å†Œé¡µé¢ç¼ºå°‘å®¢æˆ·ç«¯é‚®ç®±æ ¼å¼éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´æ— æ•ˆè¯·æ±‚æˆ–æ³¨å…¥æ”»å‡»ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `utils/validation.ts` å®ç°è¡¨å•éªŒè¯
- æ·»åŠ  `validateEmail`, `validateCode`, `validatePhone` ç­‰å‡½æ•°
- æ›´æ–°ç™»å½•é¡µé¢æ·»åŠ å®æ—¶éªŒè¯å’Œé”™è¯¯æç¤º

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/core/src/utils/validation.ts`

---

### 14. API BaseURL ç¡¬ç¼–ç  âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - ç¯å¢ƒé…ç½®

**é—®é¢˜æè¿°**:
`api/client.ts` ä¸­ BaseURL ç¡¬ç¼–ç ä¸º `http://localhost:3000/api`ï¼Œç”Ÿäº§ç¯å¢ƒå¯èƒ½æŒ‡å‘é”™è¯¯åœ°å€ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `.env.development` å’Œ `.env.production` é…ç½®æ–‡ä»¶
- æ·»åŠ  `env.d.ts` ç±»å‹å£°æ˜
- æ›´æ–° `api/services/index.ts` ä½¿ç”¨ `import.meta.env.VITE_API_BASE_URL`

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/ui/.env`
- `frontend/packages/ui/.env.development`
- `frontend/packages/ui/.env.production`
- `frontend/packages/ui/.env.example`
- `frontend/packages/ui/src/env.d.ts`

---

### 15. ç”Ÿäº§ä»£ç æ•æ„Ÿæ—¥å¿—æ³„éœ² âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - ä¿¡æ¯å®‰å…¨

**é—®é¢˜æè¿°**:
æ³¨å†Œé¡µé¢å’Œèº«ä½“æŒ‡æ ‡é¡µé¢ä½¿ç”¨ `console.log` è¾“å‡ºæ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€ä¸ªäººæ•°æ®ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `utils/logger.ts` ç»Ÿä¸€æ—¥å¿—å·¥å…·
- æ ¹æ®ç¯å¢ƒå˜é‡ `VITE_LOG_LEVEL` æ§åˆ¶æ—¥å¿—è¾“å‡º
- ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨ç¦ç”¨ debug/info æ—¥å¿—
- ç§»é™¤æ‰€æœ‰æ•æ„Ÿæ•°æ®çš„æ—¥å¿—è¾“å‡º

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/core/src/utils/logger.ts`

---

### 16. éªŒè¯ç å‘é€ç¼ºå°‘é˜²æŠ–ä¿æŠ¤ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - API æ»¥ç”¨é˜²æŠ¤

**é—®é¢˜æè¿°**:
éªŒè¯ç å‘é€åªæœ‰å‰ç«¯å€’è®¡æ—¶ï¼Œæ²¡æœ‰çœŸæ­£çš„è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œå¯èƒ½è¢«ç»•è¿‡ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `utils/throttle.ts` å®ç°é˜²æŠ–èŠ‚æµå·¥å…·
- å®ç° `createRateLimiter` è¯·æ±‚é™æµå™¨
- æ›´æ–° `auth.ts` store æ·»åŠ å‘é€é™æµï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰
- æ·»åŠ å†·å´æ—¶é—´è®¡ç®—å’ŒçŠ¶æ€ç®¡ç†

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/core/src/utils/throttle.ts`

---

### 17. TypeScript any ç±»å‹å®‰å…¨é—®é¢˜ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ä»£ç è´¨é‡

**é—®é¢˜æè¿°**:
å¤šä¸ªæ–‡ä»¶ä½¿ç”¨ `any` ç±»å‹ï¼Œç»•è¿‡äº† TypeScript ç±»å‹æ£€æŸ¥ï¼Œé™ä½äº†ä»£ç å®‰å…¨æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- ä¸º `uni.request` åˆ›å»º `UniRequestOptions` æ¥å£ç±»å‹
- ä¸º `UniApp` å¯¼èˆªæ–¹æ³•åˆ›å»º `UniNavigateOptions` æ¥å£ç±»å‹
- æ›´æ–° `api/client.ts` å’Œ `useRouteGuard.ts` ä½¿ç”¨å¼ºç±»å‹

**ä¿®æ”¹æ–‡ä»¶**:
- `frontend/packages/core/src/api/client.ts`
- `frontend/packages/core/src/composables/useRouteGuard.ts`

---

### 18. ç¼ºå°‘å…¨å±€é”™è¯¯å¤„ç† âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ç”¨æˆ·ä½“éªŒ

**é—®é¢˜æè¿°**:
é”™è¯¯å¤„ç†åˆ†æ•£åœ¨å„ä¸ªç»„ä»¶ä¸­ï¼Œç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤ºæœºåˆ¶ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `utils/error-handler.ts` å®ç°å…¨å±€é”™è¯¯å¤„ç†
- å®ç° `AppError` ç±»ç»Ÿä¸€é”™è¯¯ç±»å‹
- æ·»åŠ  `showErrorToast` ç»Ÿä¸€é”™è¯¯æç¤º
- å®ç° `withRetry` ç½‘ç»œé‡è¯•æœºåˆ¶
- æ·»åŠ é”™è¯¯æ¶ˆæ¯æ˜ å°„è¡¨

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/core/src/utils/error-handler.ts`

---

### 19. ç½‘ç»œè¯·æ±‚ç¼ºå°‘é‡è¯•æœºåˆ¶ âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ç”¨æˆ·ä½“éªŒ

**é—®é¢˜æè¿°**:
ç½‘ç»œå¤±è´¥æ—¶æ²¡æœ‰è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨é‡è¯•ï¼Œå½±å“ä½“éªŒã€‚

**è§£å†³æ–¹æ¡ˆ**:
- å®ç° `withRetry` é«˜é˜¶å‡½æ•°æ”¯æŒè‡ªåŠ¨é‡è¯•
- æ™ºèƒ½åˆ¤æ–­å¯é‡è¯•é”™è¯¯ç±»å‹ï¼ˆç½‘ç»œé”™è¯¯ã€5xxï¼‰
- æŒ‡æ•°é€€é¿é‡è¯•å»¶è¿Ÿï¼ˆ1s, 2s, 3s...ï¼‰
- æœ€å¤šé‡è¯• 3 æ¬¡

**æ–°å¢åŠŸèƒ½**:
- `withRetry(fn, maxRetries, retryDelay)` å‡½æ•°

---

### 20. ç¼ºå°‘ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€å’Œéª¨æ¶å± âœ… å·²ä¿®å¤

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ç”¨æˆ·ä½“éªŒ

**é—®é¢˜æè¿°**:
å„ä¸ªé¡µé¢çš„åŠ è½½çŠ¶æ€å’Œç©ºçŠ¶æ€ä¸ç»Ÿä¸€ï¼Œç¼ºå°‘ä¸€è‡´çš„åŠ è½½æŒ‡ç¤ºå™¨å’Œéª¨æ¶å±ç»„ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»º `components/Loading.vue` ç»Ÿä¸€åŠ è½½æŒ‡ç¤ºå™¨
- åˆ›å»º `components/Skeleton.vue` éª¨æ¶å±ç»„ä»¶
- åˆ›å»º `components/EmptyState.vue` ç©ºçŠ¶æ€ç»„ä»¶
- æ”¯æŒå¤šç§ç±»å‹å’Œå°ºå¯¸é…ç½®

**æ–°å¢æ–‡ä»¶**:
- `frontend/packages/ui/src/components/Loading.vue`
  - ç±»å‹: spinner, dots, pulse
  - å°ºå¯¸: small, medium, large
- `frontend/packages/ui/src/components/Skeleton.vue`
  - ç±»å‹: card, list, avatar, text, custom
- `frontend/packages/ui/src/components/EmptyState.vue`
  - ç±»å‹: default, network, no-search, error, no-favorites, no-records, no-achievements

---

## åç«¯é—®é¢˜ (2026-02-07)

### 21. API å“åº”æ ¼å¼ä¸ç»Ÿä¸€ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-07

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - å‰åç«¯è”è°ƒå¤±è´¥

**é—®é¢˜æè¿°**:
éƒ¨åˆ† API æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼ä¸å‰ç«¯æœŸæœ›ä¸ç¬¦ï¼Œç¼ºå°‘ `ApiResponse.ok()` åŒ…è£…ã€‚

**å½±å“èŒƒå›´**:
- `user.controller.ts`: 3 ä¸ªæ¥å£ (onboarding, getProfile, updateProfile)
- `upload.controller.ts`: 1 ä¸ªæ¥å£ (getPresignedUrl)

**è§£å†³æ–¹æ¡ˆ**:
æ‰€æœ‰æ¥å£ç»Ÿä¸€ä½¿ç”¨ `ApiResponse.ok(result)` åŒ…è£…è¿”å›å€¼ã€‚

**ä¿®å¤æäº¤**:
- `3c5928a` fix(backend): ä¿®å¤ API å“åº”æ ¼å¼ä¸ä¸€è‡´é—®é¢˜

**éªŒè¯**:
```bash
# æ‰€æœ‰æ¥å£ç°åœ¨éƒ½è¿”å›æ­£ç¡®æ ¼å¼
$ curl -X POST http://localhost:3000/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com"}'
{"success":true,"message":"éªŒè¯ç å·²å‘é€"}
```

---

## æ ¹å› åˆ†æï¼šä¸ºä»€ä¹ˆåç«¯ä¼šçŠ¯è¿™ç§ä½çº§é”™è¯¯ï¼Ÿ

### é”™è¯¯ç±»å‹ï¼šä¸ä¸€è‡´çš„å“åº”æ ¼å¼

**é—®é¢˜æœ¬è´¨**ï¼šåŒä¸€ä¸ªé¡¹ç›®å†…ï¼Œå“åº”æ ¼å¼ä¸ç»Ÿä¸€

**å½±å“èŒƒå›´**ï¼š
- âœ… `dashboard.controller.ts` â†’ `ApiResponse.ok(summary)`
- âœ… `user.controller.ts` â†’ `ApiResponse.ok(result)`
- âœ… `food.controller.ts` â†’ `ApiResponse.ok(result)`
- âŒ `auth.controller.ts` â†’ ç›´æ¥è¿”å› `service.loginWithEmail()`

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. ä»£ç å¤ç”¨æ¨¡å¼ä¸åŒ
- **å¤§å¤šæ•° Controller**: æ–°åŠŸèƒ½å¼€å‘æ—¶å‚è€ƒäº†ç°æœ‰ä»£ç ï¼ˆdashboard/userï¼‰ï¼Œæ­£ç¡®ä½¿ç”¨äº† `ApiResponse.ok()`
- **éƒ¨åˆ†æ—©æœŸæ¥å£**: æ²¡æœ‰éµå¾ªç»Ÿä¸€æ¨¡å¼

#### 2. ç¼ºå°‘ Code Review
- è¿™ç§ä¸ä¸€è‡´çš„é—®é¢˜åº”è¯¥åœ¨ PR Review æ—¶è¢«è¯†åˆ«
- ç¼ºå°‘è‡ªåŠ¨åŒ–æ£€æŸ¥æˆ– Lint è§„åˆ™æ¥å¼ºåˆ¶ç»Ÿä¸€å“åº”æ ¼å¼

#### 3. ç¼ºå°‘ç»Ÿä¸€çš„ç±»å‹çº¦æŸ
- `ApiResponse.ok()` æä¾›äº†ç±»å‹å®‰å…¨çš„åŒ…è£…
- ç›´æ¥è¿”å› Service ç»“æœç»•è¿‡äº†è¿™ä¸ªä¿æŠ¤å±‚

#### 4. å¼€å‘é€Ÿåº¦ vs è´¨é‡
- ä¸ºäº†å¿«é€Ÿå®ç°åŠŸèƒ½ï¼Œå¯èƒ½è·³è¿‡äº†æ ‡å‡†çš„å“åº”åŒ…è£…
- ç¼ºå°‘ç»Ÿä¸€çš„æ¶æ„è§„èŒƒæ–‡æ¡£

### ä¿®å¤åçŠ¶æ€ (2026-02-07)

âœ… **æ‰€æœ‰ Controller å·²ç»Ÿä¸€ä½¿ç”¨ ApiResponse.ok()**
- `auth.controller.ts` âœ…
- `dashboard.controller.ts` âœ…
- `user.controller.ts` âœ…
- `upload.controller.ts` âœ…
- `food.controller.ts` âœ…
- `diary.controller.ts` âœ…
- å…¶ä»–æ‰€æœ‰ Controller âœ…

âœ… **Swagger DTO æ³¨è§£å·²å®Œå–„**
- æ‰€æœ‰ DTO æ·»åŠ äº† `@ApiProperty()` è£…é¥°å™¨
- æ‰€æœ‰ POST æ–¹æ³•æ·»åŠ äº† `@ApiBody()` è£…é¥°å™¨

### é¢„é˜²æªæ–½

1. **å»ºç«‹å“åº”æ ¼å¼è§„èŒƒ**
   - æ‰€æœ‰ Controller æ–¹æ³•å¿…é¡»ä½¿ç”¨ `ApiResponse.ok(result)` åŒ…è£…
   - Service è¿”å›åŸå§‹æ•°æ®ï¼ŒController è´Ÿè´£åŒ…è£…

2. **ESLint è§„åˆ™**
   - ç¦æ­¢ç›´æ¥è¿”å› Service ç»“æœ
   - è¦æ±‚ä½¿ç”¨ `ApiResponse.ok()` æˆ– `ApiResponse.error()`

3. **å•å…ƒæµ‹è¯•è¦†ç›–**
   - æµ‹è¯•å“åº”æ ¼å¼å¿…é¡»åŒ…å« `success: true`
   - æµ‹è¯•å‰ç«¯èƒ½æ­£ç¡®è§£æå“åº”

4. **Code Review Checklist**
   - [ ] å“åº”æ˜¯å¦ä½¿ç”¨äº† `ApiResponse.ok()` åŒ…è£…
   - [ ] é”™è¯¯æ˜¯å¦ä½¿ç”¨äº† `ApiResponse.error()` åŒ…è£…

**æ•™è®­**: åŸºç¡€æ¶æ„çš„ä¸€è‡´æ€§æ¯”ä¸ªåˆ«åŠŸèƒ½çš„å¿«é€Ÿå®ç°æ›´é‡è¦ã€‚ä¸€æ¬¡"å·æ‡’"ä¼šå¯¼è‡´å‰åç«¯è”è°ƒå¤±è´¥ï¼Œæµªè´¹æ›´å¤šæ—¶é—´ã€‚

---

## åç«¯é—®é¢˜ (2026-02-07 ç»­)

### 22. GET /api/user/profile æ¥å£ä¸å­˜åœ¨ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-07

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - å‰åç«¯æ¥å£ä¸åŒ¹é…

**é—®é¢˜æè¿°**:
å‰ç«¯è°ƒç”¨ `GET /api/user/profile` è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„èµ„æ–™ï¼Œä½†åç«¯åªæœ‰ `GET /api/user/:id` è·¯ç”±ã€‚

**è§£å†³æ–¹æ¡ˆ**:
åœ¨åç«¯ `user.controller.ts` æ·»åŠ æ–°çš„è·¯ç”± `GET /api/user/profile`ï¼Œä» token è·å–å½“å‰ç”¨æˆ· IDã€‚

**ä¿®å¤æäº¤**:
- `bf452de` fix(backend): æ·»åŠ  GET /api/user/profile è·¯ç”±

**éªŒè¯**:
```bash
# è·¯ç”±å·²æ­£ç¡®æ³¨å†Œï¼ˆæ—  token è¿”å› 401 è€Œä¸æ˜¯ 404ï¼‰
$ curl http://localhost:3000/api/user/profile
{"success":false,"code":"UNAUTHORIZED","message":"æœªæä¾›è®¤è¯ä»¤ç‰Œ"}
```

**ç›¸å…³æ–‡ä»¶**:
- `backend/src/modules/user/user.controller.ts` (éœ€è¦æ·»åŠ æ–°è·¯ç”±)
- `frontend/packages/core/src/api/services/user.service.ts` (æ— éœ€ä¿®æ”¹)

**æ³¨æ„**: ä¿ç•™åŸæœ‰çš„ `GET /api/user/:id` è·¯ç”±ä»¥æ”¯æŒç®¡ç†å‘˜æŸ¥çœ‹å…¶ä»–ç”¨æˆ·èµ„æ–™çš„éœ€æ±‚ã€‚

---

### 23. æ³¨å†Œ/ç™»å½•é€»è¾‘æ··ä¹± âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-07

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - ä¸šåŠ¡é€»è¾‘é—®é¢˜

**é—®é¢˜æè¿°**:
æ³¨å†Œå’Œç™»å½•æ¦‚å¿µæ··æ·†ï¼Œæ–°ç”¨æˆ·ç›´æ¥"ç™»å½•"å°±åˆ›å»ºè´¦å·ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
é‡‡ç”¨**æ–¹æ¡ˆ A**ï¼Œåˆ†ç¦»æ³¨å†Œå’Œç™»å½•æ¥å£ï¼š

1. **æ–°å¢æ³¨å†Œæ¥å£** `POST /api/auth/register/email`:
   - æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
   - åˆ›å»ºç”¨æˆ·æ—¶è®¾ç½® `onboardingCompleted=false`
   - è¿”å› `needOnboarding=true`

2. **ä¿®æ”¹ç™»å½•æ¥å£** `POST /api/auth/login/email`:
   - ä¸å†è‡ªåŠ¨åˆ›å»ºè´¦å·
   - ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡ºå¼‚å¸¸
   - è¿”å› `needOnboarding` çŠ¶æ€

**ä¿®å¤æäº¤**:
- `6c4f9b8` feat(backend): åˆ†ç¦»æ³¨å†Œå’Œç™»å½•æ¥å£

**æµ‹è¯•åæ€**ï¼š
è¿™æ˜¯å·¥ä½œæ–¹å¼çš„é—®é¢˜ã€‚ä¹‹å‰çš„æµ‹è¯•åªåœç•™åœ¨ï¼š
- API èƒ½å¦è°ƒç”¨
- å“åº”æ ¼å¼æ˜¯å¦æ­£ç¡®
- Swagger æ–‡æ¡£æ˜¯å¦å®Œæ•´

ä½†æ²¡æœ‰æµ‹è¯•ï¼š
- ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§
- è¾¹ç•Œæƒ…å†µï¼ˆç”¨æˆ·ä¸å­˜åœ¨ã€å·²å­˜åœ¨ã€onboarding çŠ¶æ€ç­‰ï¼‰
- çŠ¶æ€æµè½¬æ˜¯å¦ç¬¦åˆé¢„æœŸ

**æ•™è®­**ï¼šä¼ä¸šçº§åº”ç”¨å¿…é¡»æµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼Œä¸ä»…ä»…æ˜¯æŠ€æœ¯å®ç°ã€‚

---

### 24. AI Chat è·¯ç”±æ–¹æ³•é”™è¯¯ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-07

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - å‰åç«¯æ¥å£ä¸åŒ¹é…

**é—®é¢˜æè¿°**:
AI Chat å¯¹è¯å†å²æ¥å£æ–¹æ³•é”™è¯¯ï¼Œå‰ç«¯ä½¿ç”¨ GET ä½†åç«¯æ˜¯ POSTã€‚

**ä¿®å¤å†…å®¹**:
1. `GET /api/ai/chat/history` - ä» `@Post` æ”¹ä¸º `@Get`
2. å‚æ•°ä» `@Body()` æ”¹ä¸º `@Query('limit')`
3. æ–°å¢ `DELETE /api/ai/chat/history` è·¯ç”±
4. ChatService æ·»åŠ  `clearChatHistory` æ–¹æ³•

**ä¿®å¤æäº¤**:
- `7e69fa0` fix(backend): ä¿®å¤ AI Chat è·¯ç”±æ–¹æ³•å’Œå‚æ•°é”™è¯¯

---

**æœ€åæ›´æ–°**: 2026-02-07

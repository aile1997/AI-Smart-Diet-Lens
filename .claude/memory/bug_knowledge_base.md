# AI Smart Diet Lens - é—®é¢˜çŸ¥è¯†åº“

> è®°å½•å‰åç«¯è”è°ƒä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

## åç«¯é—®é¢˜

### 1. ç”¨æˆ·èµ„æ–™ç«¯ç‚¹å®‰å…¨æ¼æ´ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

**é—®é¢˜æè¿°**:
`GET /api/user/:id` å’Œ `PUT /api/user/:id/profile` ç«¯ç‚¹æ²¡æœ‰è®¤è¯ä¿æŠ¤ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®å’Œä¿®æ”¹ä»»ä½•ç”¨æˆ·çš„èµ„æ–™ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ  `@UseGuards(JwtGuard)` è®¤è¯ä¿æŠ¤
- æ·»åŠ æ‰€æœ‰æƒæ£€æŸ¥ï¼šåªèƒ½è®¿é—®/ä¿®æ”¹è‡ªå·±çš„èµ„æ–™
- Service å±‚æ·»åŠ  `currentUserId` å‚æ•°éªŒè¯

---

### 2. CORS é…ç½®é—®é¢˜ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**é—®é¢˜æè¿°**:
å½“ `credentials: true` ä¸ `origin: '*'` ç»„åˆä½¿ç”¨æ—¶ï¼Œæµè§ˆå™¨ä¼šæŠ¥ CORS é”™è¯¯ï¼š
```
The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*'
```

**åŸå› **:
å½“éœ€è¦æ”¯æŒæºå¸¦å‡­è¯çš„è¯·æ±‚æ—¶ï¼Œ`origin` å¿…é¡»æ˜¯å…·ä½“çš„åŸŸåï¼Œä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ã€‚

**è§£å†³æ–¹æ¡ˆ**:
å°† `origin` æ”¹ä¸ºå‡½æ•°ï¼ŒåŠ¨æ€æ£€æŸ¥è¯·æ±‚æ¥æºï¼š
- å¼€å‘ç¯å¢ƒå…è®¸æ‰€æœ‰ `localhost` å’Œ `127.0.0.1` ç«¯å£
- ç”Ÿäº§ç¯å¢ƒé€šè¿‡ `CORS_ORIGIN` ç¯å¢ƒå˜é‡é…ç½®å…è®¸çš„åŸŸååˆ—è¡¨
- æ˜ç¡®é…ç½® `allowedHeaders` å’Œ `methods`

**éªŒè¯**:
```bash
curl -I -X OPTIONS http://localhost:3000/api/auth/send-code \
  -H "Origin: http://localhost:5173" \
  -H "Access-Control-Request-Method: POST"
# è¿”å›: Access-Control-Allow-Origin: http://localhost:5173
#       Access-Control-Allow-Credentials: true
```

---

### 3. API æ»¥ç”¨é£é™© âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - å®‰å…¨åŠ å›º

**é—®é¢˜æè¿°**:
æ²¡æœ‰ Rate Limitingï¼ŒAPI å¯èƒ½è¢«æ»¥ç”¨ï¼š
- éªŒè¯ç è½°ç‚¸
- æš´åŠ›ç ´è§£ç™»å½•
- èµ„æºè€—å°½æ”»å‡»

**è§£å†³æ–¹æ¡ˆ**:
æ·»åŠ  `@nestjs/throttler` åŒ…ï¼Œé…ç½®ä¸‰çº§é™æµï¼š
- **Short**: 60æ¬¡/åˆ†é’Ÿ
- **Medium**: 200æ¬¡/5åˆ†é’Ÿ
- **Long**: 1000æ¬¡/å°æ—¶

å…³é”®ç«¯ç‚¹é™æµï¼š
- å‘é€éªŒè¯ç : 5æ¬¡/åˆ†é’Ÿ
- ç™»å½•: 10æ¬¡/åˆ†é’Ÿ
- ä¸Šä¼ : 20æ¬¡/åˆ†é’Ÿ

---

### 4. ä¸Šä¼ æœåŠ¡å®‰å…¨é—®é¢˜ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P1 - å®‰å…¨åŠ å›º

**é—®é¢˜æè¿°**:
- æ²¡æœ‰æ–‡ä»¶ç±»å‹éªŒè¯ï¼Œå¯èƒ½ä¸Šä¼ æ¶æ„æ–‡ä»¶
- æ²¡æœ‰æ–‡ä»¶å¤§å°é™åˆ¶
- ä½¿ç”¨ `Math.random()` ç”Ÿæˆæ–‡ä»¶åä¸å¤Ÿå®‰å…¨

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ æ–‡ä»¶ç±»å‹ç™½åå•ï¼šä»…å…è®¸å›¾ç‰‡æ ¼å¼ (JPEG, PNG, GIF, WebP, HEIC)
- æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶ï¼šæœ€å¤§ 10MB
- ä½¿ç”¨ `crypto.randomBytes()` æ›¿ä»£ `Math.random()`

---

### 6. Diary æ¨¡å—æ‰€æœ‰æƒæ£€æŸ¥ç¼ºå¤± âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸¥é‡å®‰å…¨æ¼æ´

**é—®é¢˜æè¿°**:
`PATCH /api/diary/entry/:id` å’Œ `DELETE /api/diary/entry/:id` æ²¡æœ‰æ‰€æœ‰æƒæ£€æŸ¥ï¼Œç”¨æˆ·å¯ä»¥ä¿®æ”¹æˆ–åˆ é™¤å…¶ä»–ç”¨æˆ·çš„æ—¥è®°æ¡ç›®ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- Service å±‚æ·»åŠ  `userId` å‚æ•°
- Controller å±‚ä¼ é€’ `@CurrentUser().sub`
- éªŒè¯æ¡ç›®çš„ `userId` æ˜¯å¦ä¸å½“å‰ç”¨æˆ·åŒ¹é…

---

### 7. é‡å¤çš„ JWT Guard æ–‡ä»¶ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - ä»£ç è´¨é‡

**é—®é¢˜æè¿°**:
å­˜åœ¨ä¸¤ä¸ªåŠŸèƒ½ç›¸åŒçš„ JWT Guard æ–‡ä»¶ï¼š
- `jwt.guard.ts` - æ­£åœ¨ä½¿ç”¨
- `jwt-auth.guard.ts` - æœªä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:
åˆ é™¤æœªä½¿ç”¨çš„ `jwt-auth.guard.ts`ï¼Œç»Ÿä¸€ä½¿ç”¨ `JwtGuard`ã€‚

---

### 8. è¯·æ±‚è¿½è¸ªç¼ºå¤± âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ P2 - å¯è§‚æµ‹æ€§

**é—®é¢˜æè¿°**:
æ²¡æœ‰è¯·æ±‚ IDï¼Œéš¾ä»¥åœ¨æ—¥å¿—ä¸­è¿½è¸ªç‰¹å®šè¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

**è§£å†³æ–¹æ¡ˆ**:
- æ–°å¢ `RequestIdMiddleware` ä¸­é—´ä»¶
- ä½¿ç”¨ `crypto.randomBytes()` ç”Ÿæˆå”¯ä¸€ ID
- åœ¨å“åº”å¤´æ·»åŠ  `X-Request-ID`
- è®°å½•è¯·æ±‚è€—æ—¶ï¼ˆæ–¹æ³• + è·¯å¾„ + çŠ¶æ€ç  + è€—æ—¶ï¼‰

---

### 5. å¼€å‘æ¨¡å¼éªŒè¯ç è·å–ç«¯ç‚¹

**ç«¯ç‚¹**: `GET /api/auth/dev/code?email=xxx`

**ç”¨é€”**: å¼€å‘ç¯å¢ƒä¸‹è·å–é‚®ç®±å¯¹åº”çš„éªŒè¯ç ï¼Œæ–¹ä¾¿æµ‹è¯•

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "email": "test@example.com",
    "code": "123456",
    "expiresAt": "2026-02-06T16:39:39.397Z"
  }
}
```

---

## å‰ç«¯é—®é¢˜

### 1. UniApp æ¨¡æ¿ä¸­ `uni` å…¨å±€å¯¹è±¡ç±»å‹é”™è¯¯ âœ… å·²ä¿®å¤

**æ—¥æœŸ**: 2026-02-06

**é—®é¢˜æè¿°**:
åœ¨ Vue æ¨¡æ¿ä¸­ä½¿ç”¨ `uni.navigateTo` ç­‰å…¨å±€æ–¹æ³•æ—¶ï¼ŒTypeScript æŠ¥é”™ï¼š
```
ç±»å‹ä¸Šä¸å­˜åœ¨å±æ€§"uni"
```

**åŸå› **:
UniApp çš„å…¨å±€å¯¹è±¡ `uni` åœ¨æ¨¡æ¿ä¸Šä¸‹æ–‡ä¸­æœªè¢«æ­£ç¡®è¯†åˆ«ã€‚

**è§£å†³æ–¹æ¡ˆ**:
å°†å†…è”çš„ `uni` è°ƒç”¨ç§»åˆ° script ä¸­å®šä¹‰çš„æ–¹æ³•ï¼š
```typescript
// âŒ é”™è¯¯ï¼šæ¨¡æ¿ä¸­ç›´æ¥ä½¿ç”¨
@tap="() => uni.navigateTo({ url: '/pages/login' })"

// âœ… æ­£ç¡®ï¼šåœ¨ script ä¸­å®šä¹‰æ–¹æ³•
const goToLogin = () => {
  uni.navigateTo({ url: '/pages/onboarding/login' })
}
// æ¨¡æ¿ä¸­ä½¿ç”¨
@tap="goToLogin"
```

---

### 2. æ¨¡æ¿åµŒå¥—ç»“æ„é—®é¢˜ âœ… å·²ä¿®å¤

**é—®é¢˜æè¿°**:
ä½¿ç”¨ `<template v-else>` æ—¶å¿˜è®°æ·»åŠ é—­åˆæ ‡ç­¾ `</template>`ï¼Œå¯¼è‡´æ¨¡æ¿è§£æé”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿ `<template v-else>` æœ‰å¯¹åº”çš„é—­åˆæ ‡ç­¾ï¼š
```html
<template>
  <view>
    <view v-if="!isLoggedIn">ç™»å½•æç¤º</view>
    <template v-else>
      <!-- ä¸»å†…å®¹ -->
      <BottomNav />
    </template>  <!-- å¿…é¡»ï¼šé—­åˆ v-else æ¨¡æ¿ -->
  </view>
</template>
```

---

## å·²å®Œæˆçš„å‰åç«¯é›†æˆ

### é¡µé¢é›†æˆçŠ¶æ€

| é¡µé¢ | çŠ¶æ€ | é›†æˆå†…å®¹ |
|:-----|:-----|:---------|
| **é¦–é¡µ (Index)** | âœ… | useDashboard, ç™»å½•æ£€æŸ¥ |
| **æ¶ˆæ¯ä¸­å¿ƒ (Messages)** | âœ… | NotificationsService, å·²è¯»/æœªè¯» |
| **AI åˆ†æ (Analysis)** | âœ… | useAnalysis, çƒ­é‡è¶‹åŠ¿, è¥å…»åˆ†å¸ƒ |
| **ä¸ªäººä¸­å¿ƒ (Profile)** | âœ… | useUserStore, useDashboard, ç™»å‡º |
| **è®¾ç½® (Settings)** | â³ | å¾…é›†æˆ |

### æ–°å¢ Composables

| æ–‡ä»¶ | åŠŸèƒ½ |
|:-----|:-----|
| `useDashboard.ts` | ä»ªè¡¨ç›˜æ•°æ®ç®¡ç† |
| `useAnalysis.ts` | è¥å…»åˆ†æè¶‹åŠ¿æ•°æ® |
| `useRouteGuard.ts` | è·¯ç”±å®ˆå« |

### æ–°å¢ Services

| æ–‡ä»¶ | åŠŸèƒ½ |
|:-----|:-----|
| `dashboard.service.ts` | ä»ªè¡¨ç›˜ API |
| `notifications.service.ts` | æ¶ˆæ¯é€šçŸ¥ API |

---

**æœ€åæ›´æ–°**: 2026-02-06

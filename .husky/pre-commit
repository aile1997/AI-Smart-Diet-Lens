#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” è¿è¡Œ pre-commit æ£€æŸ¥..."

# æ£€æŸ¥æµ‹è¯•æ–‡ä»¶å®Œæ•´æ€§
echo ""
echo "æ£€æŸ¥æµ‹è¯•æ–‡ä»¶å®Œæ•´æ€§..."

REQUIRED_TEST_FILES=(
  "frontend/packages/core/tests/composables/useAuth.spec.ts"
  "frontend/packages/core/tests/composables/useBooking.spec.ts"
  "frontend/packages/core/tests/composables/useSeat.spec.ts"
  "frontend/packages/core/tests/composables/useZone.spec.ts"
)

for file in "${REQUIRED_TEST_FILES[@]}"; do
  if [ ! -f "$file" ]; then
    echo "âŒ é”™è¯¯: æµ‹è¯•æ–‡ä»¶ç¼ºå¤±: $file"
    echo "è¯·æ¢å¤æµ‹è¯•æ–‡ä»¶åå†æäº¤!"
    exit 1
  fi
done

echo "âœ… æ‰€æœ‰å¿…éœ€çš„æµ‹è¯•æ–‡ä»¶éƒ½å­˜åœ¨"

# é›¶æ±¡æŸ“æ£€æŸ¥
echo ""
echo "æ£€æŸ¥å¹³å° API æ³„éœ²..."

if grep -r "uni\." frontend/packages/core/src/ --include="*.ts" --include="*.js" | grep -v "^[^:]*://"; then
  echo "âŒ é”™è¯¯: Core å±‚å‘ç° uni.xxx è°ƒç”¨!"
  echo "Core å±‚ä¸¥ç¦ä½¿ç”¨å¹³å°ç‰¹å®š APIï¼Œè¯·é€šè¿‡ adapters æ¥å£è¿›è¡ŒæŠ½è±¡ã€‚"
  exit 1
fi

echo "âœ… é›¶æ±¡æŸ“æ£€æŸ¥é€šè¿‡"

# è¿è¡Œ core å±‚æµ‹è¯•
echo ""
echo "è¿è¡Œæ ¸å¿ƒå±‚æµ‹è¯•..."
cd frontend
pnpm --filter @zenspace/core test --run

if [ $? -ne 0 ]; then
  echo "âŒ é”™è¯¯: æµ‹è¯•å¤±è´¥"
  echo "è¯·ä¿®å¤æµ‹è¯•åå†æäº¤!"
  exit 1
fi

echo "âœ… æµ‹è¯•é€šè¿‡"
echo ""
echo "ğŸ‰ Pre-commit æ£€æŸ¥å…¨éƒ¨é€šè¿‡!"

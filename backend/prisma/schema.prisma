// AI Smart Diet Lens - 数据库模型
// 使用 Prisma ORM + PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  nickname  String?
  avatar    String?
  bio       String?  /// 个人简介

  // 微信授权相关
  wechatOpenid   String?  @unique  /// 微信 OpenID
  wechatUnionid  String?            /// 微信 Unionid (多应用共享)

  // 邮箱验证相关
  emailVerified  Boolean  @default(false)
  verificationCode String? /// 验证码 (6位数字)
  gender    String?
  age       Int?
  height    Float?   /// 身高 (cm)
  weight    Float?   /// 体重 (kg)
  bodyFat   Float?   /// 体脂率 (%)
  goal      String?  /// 健身目标: lose_weight | maintain | gain_muscle
  activityLevel Float? /// 活动等级系数
  dailyCalorieTarget Int? /// 每日目标热量
  targetWeight Float? /// 目标体重

  /// 宏量营养素目标 (g)
  proteinTarget Float? /// 蛋白质目标
  carbsTarget   Float? /// 碳水目标
  fatTarget     Float? /// 脂肪目标

  onboardingCompleted Boolean @default(false)

  diaryEntries DiaryEntry[]
  achievements UserAchievement[]
  healthMetrics HealthMetric[]
  chatMessages ChatMessage[]
  communityPosts CommunityPost[]
  comments Comment[]
  favorites Favorite[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

/// 食物库
model Food {
  id       String @id @default(cuid())
  name     String
  category String?

  /// 每 100g 营养成分
  calories Float
  protein  Float
  carbs    Float
  fat      Float
  fiber    Float?
  sodium   Float?

  imageUrl String?

  diaryEntries DiaryEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("foods")
}

/// 饮食日记条目
model DiaryEntry {
  id       String @id @default(cuid())
  userId   String
  foodId   String? /// 可选：关联到食物库
  mealType String /// breakfast | lunch | dinner | snack
  portion  Float  /// 份量 (g)
  date     String /// YYYY-MM-DD

  /// 计算后的营养成分
  calories Float
  protein  Float
  carbs    Float
  fat      Float

  note String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  food Food? @relation(fields: [foodId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@map("diary_entries")
}

/// 成就定义
model Achievement {
  id          String @id @default(cuid())
  name        String
  description String
  category    String /// weight_loss | nutrition | ai_explorer | consistency
  icon        String
  target      Int    /// 目标值

  userAchievements UserAchievement[]

  @@map("achievements")
}

/// 用户成就 (多对多关联)
model UserAchievement {
  id            String @id @default(cuid())
  userId        String
  achievementId String
  progress      Int    @default(0)
  unlocked      Boolean @default(false)
  unlockedAt    DateTime?

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

/// 健康指标记录
model HealthMetric {
  id        String   @id @default(cuid())
  userId    String
  type      String   /// STEPS | BODY_FAT | WEIGHT | SLEEP | ACTIVE_CALORIES
  value     Float
  recordedAt DateTime /// 记录时间
  source    String?  /// 来源: YOLANDA_SCALE | APPLE_HEALTH | GOOGLE_FIT | MANUAL

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, type, recordedAt])
  @@map("health_metrics")
}

/// AI 对话消息
model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  isUser    Boolean /// true: 用户消息, false: AI 回复
  content   String   @db.Text
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

/// 社区帖子
model CommunityPost {
  id        String   @id @default(cuid())
  userId    String
  content   String   @db.Text
  images    String[]
  tags      String[]
  likes     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@map("community_posts")
}

/// 帖子评论
model Comment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

/// 收藏
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  itemId    String
  type      String   /// recipe | food
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId, type])
  @@map("favorites")
}

/// 系统消息通知
model Message {
  id        String   @id @default(cuid())
  userId    String
  type      String   /// achievement | reminder | system
  title     String
  content   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("messages")
}
